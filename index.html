<!DOCTYPE html>
<html lang="en">

<head>
  <title>Chet | Chess bot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cm-chessboard@8/assets/chessboard.css">
</head>

<body>
  <nav>
    <h3>Chet</h3>
  </nav>

  <main x-data="Chess()" x-init="init">
    <div id="actions">
      <button @click="newGame">New Game</button>
    </div>
    <div id="board"></div>
    <div id="status" x-text="statusMsg"></div>
  </main>

  <script type="module">
    import { Chessboard, FEN, INPUT_EVENT_TYPE } from "https://cdn.jsdelivr.net/npm/cm-chessboard@8/src/Chessboard.js";

    function Chess() {
      const LOADING = 1, PLAYING = 2, GAME_OVER = 3;

      return {
        game: undefined,
        status: undefined,
        statusMsg: '',
        board: undefined,

        init() {
          this.loadGame();
        },

        async newGame() {
          this.setStatus(LOADING, "Loading...");
          const resp = await fetch('/games', { method: 'POST' });
          this.setGame(await resp.json());
          this.setStatus(PLAYING);
        },

        setGame(g) {
          this.game = g;
          if (this.board) this.board.destroy();
          this.board = new Chessboard(document.getElementById("board"), {
            position: g.fen,
            assetsUrl: "https://cdn.jsdelivr.net/npm/cm-chessboard@8/assets/",
            style: {
              showCoordinates: false
            }
          });
          this.board.enableMoveInput(this.inputHandler.bind(this));
          sessionStorage.setItem('chet.game', JSON.stringify(g));
        },

        loadGame() {
          const g = sessionStorage.getItem('chet.game');
          if (g) {
            const game = JSON.parse(g);
            this.setGame(game);
            this.setStatus(PLAYING);
          } else {
            this.newGame();
          }
        },

        inputHandler(event) {
          if (this.status !== PLAYING) return false;
          const move = `${event.squareFrom}${event.squareTo}`;

          switch (event.type) {
            case INPUT_EVENT_TYPE.validateMoveInput:
              return this.game.legal_moves.includes(move);

            case INPUT_EVENT_TYPE.moveInputFinished:
              if (event.legalMove) this.makeMove(move);
              else return false;

            default:
              return true;
          }
          return true;
        },

        async makeMove(move) {
          this.setStatus(LOADING, "Thinking...");

          const resp = await fetch(`/games/${this.game.id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: this.game.id,
              fen: this.game.fen,
              move,
            }),
          });
          const newGameObj = await resp.json();
          const [from, to] = [newGameObj.last_move.slice(0, 2), newGameObj.last_move.slice(2)];
          const compMove = from + '-' + to;

          if (compMove) this.board.movePiece(from, to, true);

          this.game = newGameObj;
          sessionStorage.setItem('chet.game', JSON.stringify(newGameObj));
          this.loadGame();

          if (newGameObj.status_desc) {
            this.setStatus(GAME_OVER, newGameObj.status_desc);
          } else {
            this.setStatus(PLAYING, "Computer moved: " + compMove);
          }
        },

        setStatus(s, msg) {
          this.status = s;
          this.statusMsg = msg;
        }
      }
    }

    window.Chess = Chess;
  </script>

  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    nav {
      display: flex;
      justify-content: center;
      background: aliceblue;
      padding: 10px;

      h3 {
        margin: 0;
      }
    }

    main {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 30px;
    }

    #board {
      width: 100%;
      max-width: 60vh;
    }

    #status {
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</body>

</html>
