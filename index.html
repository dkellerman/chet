<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cm-chessboard@8/assets/chessboard.css">
</head>

<body>
  <nav>
    <h3>Chet</h3>
  </nav>

  <main x-data="App()">
    <div id="actions"><button @click="newGame">New Game</button></div>
    <div id="board"></div>
    <div id="status" x-text="statusMsg"></div>
  </main>

  <script type="module">
    import { Chessboard, FEN, INPUT_EVENT_TYPE } from "https://cdn.jsdelivr.net/npm/cm-chessboard@8/src/Chessboard.js";

    window.App = () => {
      const LOADING = 1, PLAYING = 2, GAME_OVER = 3;
      let game, status, statusMsg, board;

      loadGame();

      async function newGame() {
        setStatus(LOADING, "Loading...");
        const resp = await fetch('/games', { method: 'POST' });
        setGame(await resp.json());
        setStatus(PLAYING);
      }

      function loadGame() {
        const g = sessionStorage.getItem('chet.game');
        if (g) {
          const game = JSON.parse(g);
          setGame(game);
          setStatus(PLAYING);
        } else {
          newGame();
        }
      }

      function setGame(g) {
        game = g;
        if (board) board.destroy();
        board = new Chessboard(document.getElementById("board"), {
          position: game.fen,
          assetsUrl: "https://cdn.jsdelivr.net/npm/cm-chessboard@8/assets/"
        });
        board.enableMoveInput(inputHandler);
        sessionStorage.setItem('chet.game', JSON.stringify(game));
      }

      function setStatus(s, msg) {
        status = s;
        statusMsg = msg;
      }

      function inputHandler(event) {
        // console.log(event);
        if (event.type === INPUT_EVENT_TYPE.validateMoveInput) {
          return game.legal_moves.includes(`${event.squareFrom}${event.squareTo}`);
        } else if (event.type === INPUT_EVENT_TYPE.moveInputFinished && event.legalMove) {
          const move = `${event.squareFrom}${event.squareTo}`;
          console.log("move", move);
          return makeMove(move);
        }
        return true;
      }

      async function makeMove(move) {
        const resp = await fetch(`/games/${game.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: game.id,
            fen: game.fen,
            move,
          }),
        });
        const newGameObj = await resp.json();
        const [from, to] = [newGameObj.last_move.slice(0, 2), newGameObj.last_move.slice(2)];
        const compMove = from + '-' + to;

        console.log("comp move", compMove);
        console.log("new game state", newGameObj);
        if (compMove) {
          board.movePiece(from, to, true);
        }

        game = newGameObj;
        sessionStorage.setItem('chet.game', JSON.stringify(newGameObj));
        loadGame();

        if (newGame.status_desc) {
          setStatus(GAME_OVER, newGame.status_desc);
        } else {
          setStatus(PLAYING, "Computer moved: " + compMove);
        }
      }

      return {
        statusMsg,
        newGame,
      };
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    nav {
      display: flex;
      justify-content: center;
      background: aliceblue;
      padding: 10px;

      h3 {
        margin: 0;
      }
    }

    main {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 30px;
    }

    #board {
      width: 100%;
      max-width: 70vh;
    }

    #status {
      font-size: 24px;
      font-weight: bold;
    }
  </style>
</body>

</html>
